## 项目概览
- 前端：`React + Vite + Tailwind`，核心代码位于 `frontend/src`，Telegram WebApp 集成在 `providers/TMAProvider.tsx`。主要页面：`pages/Home.tsx` 与 `pages/TMAHome.tsx`（两者功能重叠）。
- 后端：Vercel Serverless（Node），端点位于 `server/api/*.js`，通过 `vercel.json` 路由到 `/api/*`。
- 数据库：Supabase，三张核心表（`user_credits`、`payments`、`referrals`），迁移文件位于 `supabase/migrations/001_init.sql`。
- 部署：Vercel 根级 `vercel.json` 将静态前端与后端函数统一部署，环境变量通过 Vercel 项目秘钥注入。

## 现状评估与问题报告
- 关键（需优先修复）
  - 前后端接口字段不一致：后端 `consume.js` 期望 `composite_image_base64/prompt/chat_id`（`server/api/consume.js:9-27`），但前端 `Home.tsx` 已对齐（`frontend/src/pages/Home.tsx:287-297`），`TMAHome.tsx` 发送 `{ initData, task: payload }`（`frontend/src/pages/TMAHome.tsx:88-91`），产生不匹配。
  - API 基础地址使用不一致：`.env.example` 中 `VITE_PAYMENTS_BASE_URL` 已包含 `/api`（`.env.example:13-14`），`TMAHome.tsx` 拼接为 `${baseUrl}/api/...`（`frontend/src/pages/TMAHome.tsx:70-88`），导致路径重复 `/api/api/...`；`Home.tsx` 同样如此（`frontend/src/pages/Home.tsx:119-145`）。
  - 安全验证不足：除 `create-invoice.js` 外，`balance.js`、`consume.js`、`referral-link.js`、`balance-with-referral.js`未调用 `verifyInitData` 完整校验（`server/api/balance.js:15-25`、`server/api/consume.js:15-25`、`server/api/referral-link.js:21-25`、`server/api/create-invoice.js:21-23`）。在使用 `SUPABASE_SERVICE_ROLE_KEY` 的前提下必须强校验。
  - Supabase 更新语法错误：`balance-with-referral.js` 使用 `SUPABASE.raw('credits + 1')`（`server/api/balance-with-referral.js:51-54`），`supabase-js` 无该接口，推荐改为集中调用 `addCredits()` 或 RPC。
- 重要（尽快修复）
  - 重复/分叉的支付与余额逻辑：`usePayments.ts` 与两套页面各自实现，建议统一通过 `usePayments` 并清理页面内重复网络调用（`frontend/src/hooks/usePayments.ts`、`frontend/src/pages/Home.tsx`、`frontend/src/pages/TMAHome.tsx`）。
  - 环境变量命名不一致：文档使用 `TELEGRAM_BOT_TOKEN/USERNAME`（`docs/telegram-bot-setup.md:104-107`），代码使用 `TELEGRAM_TOKEN/BOT_USERNAME`（`server/api/*.js`、`vercel.json:26-33`）。
  - Webhook 默认值硬编码：`consume.js` 存在 Make Webhook 兜底 URL（`server/api/consume.js:34`），建议强制使用环境变量并增加超时/重试与签名校验。
- 优化（提升质量与可维护性）
  - 强输入校验与限流：所有 `/api/*` 增加请求体/查询参数校验、速率限制与统一错误响应结构。
  - 观测与审计：统一结构化日志，记录 `request_id`、`user_id` 与关键事件；支付与扣点操作添加审计（`payments`/`user_credits`变更记录）。
  - RLS 策略：若未来前端直连 Supabase，需开启细粒度 RLS；当前服务端持有 Service Role 则必须严格鉴权。

## 前后端接口对接验证
- 端点列表与数据格式
  - `GET /api/balance`：query `initData`，返回 `{ success, credits, userId }`（`server/api/balance.js:30-34`）。
  - `GET /api/balance-with-referral`：同上，首登送 3 点并记录推荐（`server/api/balance-with-referral.js:28-57`）。
  - `POST /api/create-invoice`：body `{ initData, sku }`，返回 `{ success, invoiceLink }`（`server/api/create-invoice.js:66-69`）。
  - `POST /api/consume`：body `{ initData, composite_image_base64, prompt, chat_id }`，返回 `{ success }`，失败返还积分（`server/api/consume.js:27-57`）。
  - `POST /api/webhook`：Telegram 成功支付回调，增加积分并记录支付（`server/api/webhook.js:46-101`）。
  - `GET /api/referral-link`：生成 Bot/MiniApp/Web 推荐链接（`server/api/referral-link.js:40-48`）。
- 前端调用现状
  - `Home.tsx`：路径与字段基本与后端对齐，但基础地址拼接了 `/api`（`frontend/src/pages/Home.tsx:119-145`）。
  - `TMAHome.tsx`：路径与字段均需统一为后端格式（`frontend/src/pages/TMAHome.tsx:70-91`）。
  - `usePayments.ts`：建议前端统一迁移到该 Hook（`frontend/src/hooks/usePayments.ts:21-41,71-107`）。

## 数据库结构与迁移评估
- 表结构合理，满足积分、支付与推荐需求（`supabase/migrations/001_init.sql`）。
- 执行记录与权限声明在 `001_init_executed.sql`（`supabase/migrations/001_init_executed.sql:29-40`）；后续建议将权限与 RLS 拆分到独立迁移并版本化。
- 推荐增加 `admins` 表或环境变量白名单（见“沙盒与权限”），用于管理管理员身份与特权操作。

## 安全性评估
- 用户认证：建议所有端点必须执行 `verifyInitData(initData, TELEGRAM_TOKEN)` 校验；并校验 `user.id` 与业务请求的 `chat_id` 一致。
- 数据加密与秘钥：Vercel 环境变量管理符合最佳实践；避免在代码中出现默认 Webhook URL。
- 防注入：使用 `supabase-js` 参数化接口风险较低；避免字符串拼接的 SQL；推荐引入服务端字段白名单校验。
- 支付幂等与审计：`webhook.js` 已有去重逻辑（`server/api/webhook.js:33-44`）；建议所有扣点/返还操作统一在事务或“幂等键”保护下。

## 生产部署方案
- 环境准备：
  - Vercel 项目：设置 `SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY/TELEGRAM_TOKEN/BOT_USERNAME/MAKE_WEBHOOK_URL/APP_BASE_URL/VITE_PAYMENTS_BASE_URL`（`vercel.json:26-33`）。
  - Supabase：执行 `supabase/migrations/001_init.sql`，创建表并配置权限；若采用 `admins`，追加迁移。
  - Telegram：BotFather 启用 Stars 支付与 Webhook（`docs/telegram-bot-setup.md:39-47,64-76`）。
  - Webhook：`/api/webhook` 设置为 Telegram Webhook 目标。
- 构建与路由：
  - 前端 `frontend/package.json` 构建产物 `frontend/dist`；路由 `/` 指向静态，`/api` 指向 `server/api`（`vercel.json:16-24`）。

## 非技术人员配合清单
- 内容录入指南（CMS 替代方案）
  - 管理提示词：通过编辑 `frontend/src/config/prompts.json`（`frontend/src/config/prompts.json`）并重新构建发布；包含分步截图（构建后提供）。
  - 管理用户与支付：通过 Supabase 控制台查看 `user_credits/payments/referrals`，提供操作指引（新增用户积分、查询支付、处理推荐）。
- 测试数据准备
  - 提供 Excel 模板（工作表：`Users`、`Payments`、`Referrals`）：字段分别为 `telegram_user_id, credits` / `telegram_user_id, xtr_amount, credits_added, paid_at, payment_ref` / `inviter_id, invitee_id, created_at`，内含填写规范与示例行。
- 第三方服务配置
  - Telegram Stars 商户流程：BotFather 启用 Stars、设置命令、描述与头像（`docs/telegram-bot-setup.md:39-62`）。
  - Make.com：提供 Webhook 创建与签名校验流程文档。
- 域名/服务器权限清单
  - 需提供：Vercel 项目访问、Supabase 项目访问、Telegram Bot Token 与用户名、Make.com 账号与 Webhook 密钥、域名 DNS 管理权限。
- 验收检查表
  - 非技术要点：能打开 WebApp、能上传图片并绘制、支付包展示正确、支付完成后余额增加、扣点成功并触发处理、推荐链接能生成且邀请关系成立、Webhook 信息可在后台查到。

## 沙盒环境部署与测试方案
- 环境隔离
  - 创建独立的 Vercel 项目与 Supabase 项目作为“测试/预发”环境；Telegram 使用测试 Bot（或测试群）并单独设 Webhook。
  - `VITE_PAYMENTS_BASE_URL` 指向测试域名，避免误触生产。
- 测试支付通道（沙箱模式）
  - Stars 无官方沙箱时：配置最低价包用于回归、或使用“模拟支付”与 Webhook 手工回放（`docs/telegram-bot-setup.md:78-97`）。
- 管理员权限
  - 为指定测试账号 `chatid:1740576312` 配置管理员：两种方案供选择
    - 环境变量白名单：新增 `ADMINS=1740576312,...`，在后端读取并判定特权。
    - 数据库表：新增 `admins(telegram_user_id bigint primary key, role text)`，通过迁移管理（推荐长期方案）。
- 测试用例清单
  - 余额查询：正常/缺失 `initData`/非法哈希。
  - 创建发票：有效 SKU/无效 SKU/Telegram API 失败。
  - 支付回调：重复回调去重、积分正确记账、推荐奖励生效。
  - 扣点与返还：任务成功/Webhook 失败返还积分、超时处理。
  - 推荐链路：`/start ref_xxx` 与 Web/MiniApp 深链生成与解析。
  - 兼容性：移动与桌面 Telegram 客户端，弱网与大图边界（3MB）。
- 问题反馈与紧急回滚
  - 问题反馈：建立表单或飞书/Slack 频道，收集时间戳、用户ID、操作与错误截图。
  - 回滚流程：
    - 代码：Vercel 回滚到上一次构建。
    - 数据：提供 SQL 脚本回滚积分（按 `payments` 差异）、撤销误写入推荐；参考 `supabase/cleanup/*.sql`。

## 后续实施计划（待您确认后执行）
- 统一接口与路径：
  - 前端移除 `${baseUrl}/api` 的重复拼接，统一调用 `VITE_PAYMENTS_BASE_URL`。
  - `TMAHome.tsx` 改为传递 `consume` 所需字段，与 `Home.tsx` 保持一致。
  - 前端统一使用 `usePayments`，保留一套页面逻辑并删除重复网络调用。
- 安全加固：
  - 在 `balance/consume/referral-link/balance-with-referral` 中接入 `verifyInitData`，校验 `hash` 与 `user.id`。
  - 移除 `SUPABASE.raw` 的用法，改为 `addCredits()` 或 RPC。
  - 强制 `MAKE_WEBHOOK_URL` 存在且校验响应；增加超时/重试与失败审计。
- 管理员与运营支持：
  - （征求您授权）创建 `admins` 表迁移或采用 `ADMINS` 环境变量；将 `1740576312` 设为测试管理员。
- 文档与交付物：
  - 提供：问题报告（分级）、CMS 操作手册（含截图）、Excel 模板、第三方配置流程、非技术验收检查表。

如您确认上述方案，我将开始分阶段落地修复、编写文档并配置沙盒环境。